% This is LLNCS.DEM the demonstration file of
% the LaTeX macro package from Springer-Verlag
% for Lecture Notes in Computer Science,
% version 2.4 for LaTeX2e as of 16. April 2010
%
\documentclass{llncs}
%
\usepackage{makeidx}  % allows for indexgeneration
%
\usepackage{todonotes}
%
\usepackage{booktabs}
\usepackage{graphicx}


\begin{document}
%
\frontmatter          % for the preliminaries
%
\pagestyle{headings}  % switches on printing of running heads
\addtocmark{Alpha Shapes for Tumor Inclusion} % additional mark in the TOC
%

%
\tableofcontents
%
\listoftodos

\mainmatter              % start of the contributions
%
\todo[author=SG,inline]{Share document with Prof. Reinhardt once this is in at least a rough draft form}
\todo[author=SG,inline]{Change title and running title}
\title{Ultimate Best Total Lung Segmentation via Alpha Shapes in the presence of large volume tumors}
%
\titlerunning{Alpha Shape Lung Segmentation}  % abbreviated title (for running head)
%                                     also used for the TOC unless
%                                     \toctitle is used
%
\todo[author=All, inline]{\\citep command available for parenthesis citation with natbib}
\todo[author=SG, inline]{Set Authors}
\author{Sarah E. Gerard\inst{1} \and Hans J. Johnson\inst{1}
\and Joseph M. Reinhardt\inst{1}}
%
\authorrunning{Sarah E. Gerard et al.} % abbreviated author list (for running head)
%
%%%% list of authors for the TOC (use if author list has to be modified)
\tocauthor{Sarah E. Gerard, Hans J. Johnson, Joseph M. Reinahrdt}
%
\institute{University of Iowa, Iowa City IA 52402, USA,\\
\email{sarah-gerard@uiowa.edu}
}


\maketitle              % typeset the title of the contribution

\begin{abstract}
Lung segmentation is a critical initial step for radiation therapy interventions of lung cancer patients. However, automatic segmentation of lungs with large tumors is a challenging task due to the large variation of both lung and tumor shape between subjects. We present a method to segment lungs with large tumors in CT images using an initial intensity based segmentation followed by alpha shape construction and graph search. We evaluated our method on twelve subjects. Compared to manual segmentations, we obtained an average DICE coefficient of XXX and an average surface distance of XXX. The results show that our method is able to accurately include large tumors. Additionally, when the method is performed on lungs with no tumors the initial lung segmentation is not significantly changed. 

\keywords{segmentation, alpha shapes, lung}
\end{abstract}
%
\section{Introduction}
%
Radiation therapy interventions of lung cancer patients involve acquiring a thoracic CT scan. Typically a respiratory correlated scan, or 4D CT, is also acquired prior to treatment. This produces a huge amount of data, requiring automatic computer-aided methods for further analysis. Accurate delineation of the lungs is a critical initial first step for treatment planning and quantitative analysis.

Normal lungs have high contrast with the surrounding anatomy, making lung segmentation relatively trivial using thresholding based methods ~\cite{guo2008,hu2001}. However, in the presence of large tumors, conventional threshold based methods fail because tumors are excluded from the segmentation. 

Several approaches have been used to segment pathological lungs. Statistical shape models are able to capture the major modes of lung shape variation in a training set and then build a lung model ~\cite{sun2012,sofka2011}. This method requires a large training set with annotated corresponding landmark points. Additionally, the training set is limited to a subset of possible lung shape variations and thus it could fail on cases that are not represented in the training set. Segmentation by registration methods ~\cite{sluimer2005,vanrikxoort2009} make use an atlas or multiple atlases with ground truth segmentations. The atlas segmentation is mapped to a test case using image registration. For good results, a time consuming registration is needed.

In this paper we propose an alpha shape approach for inclusion of large tumors in lung segmentations. Alpha shapes have been used for XXXXX. To the best of our knowledge this is the first time alpha shapes have been used for inclusion of large tumors for lung segmentation. 


%
\section{Methods}
%
The proposed method has three main steps: initial intensity based segmentation, alpha shape computation of initial mask, and an optimal graph search for final refinement. Each of these steps will be described next.
%
\subsection{Initial Segmentation}
%
First we obtain intensity based segmentation of the lungs using PASS software ~\cite{guo2008}. This method consists of three main steps: extraction of lungs using optimal thresholding, separation of the right and left lungs, and optimal smoothing to smooth the lung boundaries. This gives a lung mask for both left and right lung, however large tumors are not included. We will refer to this as the initial mask. The next steps will process initial mask for the left and right lung separately. 
%
\subsection{Alpha Shapes}
%
Using our prior knowledge that the lung shape is approximately convex along the ribcage, we observed that taking the convex hull of the initial mask gives a shape that includes large tumors. However, the convex hull over segments the lung in non convex regions such as the mediastinum and diaphragm. Using alpha shapes we were able to elegantly obtain a family of shapes representing the initial mask. 

The concept of using alpha shapes to represent a point set was originally presented in ~\cite{edelsbrunner1983}. A convex hull is a generalization of an alpha shape; all convex hulls are alpha shapes but not all alpha shapes are convex hulls. By adjusting a single parameter $\alpha$ a family of shapes associated with a finite set of points can be obtained.

Alpha shapes are closely associated with the Delaunay triangulation of a set of points, with the boundary of the alpha shape being a subset of the Delaunay triangulation. The alpha shape consists of all simplices in the Delaunay triangulation such that the radius of the simplex circumsphere is not greater than $ \alpha $. For the two extremes, $ \alpha=\inf $ gives the convex hull and  $ \alpha=0 $ gives the point set. 

Our goal is to find the alpha shape of the initial lung mask that includes the tumor region. First we obtain a set of points representing the initial mask. The convex hull, or alpha shape with $ \alpha = \inf $, of the initial mask includes the tumor region however it also over segments non convex regions on the lung such as the mediastinum and diaphragm. By reducing alpha we can exclude most of the over segmentation near mediastinum and diaphragm. If alpha is too small, the tumor region is excluded. Figure ~\ref{fig:alphashapes} shows the alpha shape of the initial mask for different values of alpha. 

\todo[author=JMR,inline]{Professor Reinhardt is there a way to crop the black out of the figure within latex?}
\begin{figure}[t]
  \centering
  \begin{tabular}{ccc}
    \includegraphics[trim={200 5 200 5},clip, width=1.55in]{figs/alpha200} & 
    \includegraphics[trim={200 5 200 5},clip, width=1.55in]{figs/alpha25} & \includegraphics[trim={200 5 200 5},clip, width=1.55in]{figs/alpha9} \\
  \end{tabular}
  \caption{Alpha shape for for $\alpha=200$, $\alpha=25$, and $\alpha=9$ from left to right}
  \label{fig:alphashapes}
\end{figure}
%
\subsection{Graph Search}
%
The final step uses a graph search to remove regions with small over segmentation. The method will only briefly be described here, see ~\cite{li2006} for a detailed description of the method. 
%
\section{Data Sets and Experimental Setup}
%
In this study we used breath-hold thoracic CT scans from twelve lung cancer subjects about to undergo radiation therapy. All scans were gathered under a protocol approved by the University of Iowa Institutional Review Board (IRB 200905703). All images were resampled to obtain $1\times{}1\times{}1$ mm$^3$ voxels. Subjects were chosen that had at least one large tumor. 

Out method was evaluated by comparing to ground truth segmentations done by an expert using XXX software. The DICE coefficent was used for a metric of volume overlap. Additionally, the symmetric surface distance was used to measure the distance between the segmentation boundaries. The analysis was performed on both left and right lungs of all subjects. Additionally, we repeated the analysis with only considering the lung containing the tumor.


The proposed method was implemented using the jupyter notebook \cite{PER-GRA:2007} rapid prototyping environmnet,  algorithms from ITK\cite{johnson2015itk} python wrapped in SimpleITK \cite{10.3389/fninf.2013.00045} in coordination with vtkDelaunay3D from VTK (www.vtk.org).


%
\section{Results}
%
Table ~\ref{tab:results} shows the DICE coefficient and surface distance for left and right lungs of each subject. 

% define table layout and column spacing here
\newlength\intercol
\setlength\intercol{15pt}
\newlength\betweenwidth
\setlength\betweenwidth{10pt}
\newcommand\icspace{@{\hspace\intercol}}
\newcommand\inspace{@{\hspace\betweenwidth}}
\newcommand\MC[1]{\multicolumn{2}{c\icspace}{#1}}
\newcommand\MClast[1]{\multicolumn{2}{c}{#1}}

\begin{table}
  \centering
  \begin{tabular}{c@{\hspace{20pt}} c \inspace c \icspace c \inspace c \icspace c \inspace c}
    \toprule
    Subject & \MC{DICE}   & \MC{Surface Distance}  & \MC{HD}\\
            & Left & Right & Left & Right & Left & Right \\
    \midrule
    A & XXX & XXX & XXX & XXX & XXX & XXX \\
    B & XXX & XXX & XXX & XXX & XXX & XXX \\
    C & XXX & XXX & XXX & XXX & XXX & XXX \\
    D & XXX & XXX & XXX & XXX & XXX & XXX \\
    E & XXX & XXX & XXX & XXX & XXX & XXX \\
    F & XXX & XXX & XXX & XXX & XXX & XXX \\
    G & XXX & XXX & XXX & XXX & XXX & XXX \\
    H & XXX & XXX & XXX & XXX & XXX & XXX \\
    I & XXX & XXX & XXX & XXX & XXX & XXX \\
    J & XXX & XXX & XXX & XXX & XXX & XXX \\
    K & XXX & XXX & XXX & XXX & XXX & XXX \\
    L & XXX & XXX & XXX & XXX & XXX & XXX \\
    \midrule
    Mean & XXX & XXX & XXX & XXX & XXX & XXX \\
    \bottomrule \\
  \end{tabular}
  \caption{Results for proposed method compared to manual segmentations.}
  \label{tab:results}
\end{table}

Figure ~\ref{fig:steps} shows the resulting segmentation at each step of the method for one subject.

\todo[author=JMR,inline]{Professor Reinhardt is there a way to crop the black out of the figure within latex?}
\begin{figure}[t]
  \centering
  \begin{tabular}{ccc}
    \includegraphics[trim={200 5 200 5},clip, width=1.55in]{figs/step_pass} & 
    \includegraphics[trim={200 5 200 5},clip, width=1.55in]{figs/step_alpha} & \includegraphics[trim={200 5 200 5},clip, width=1.55in]{figs/step_osf} \\
  \end{tabular}
  \caption{Result after each step of the proposed method.}
  \label{fig:steps}
\end{figure}
Figure XXX shows the final segmentation for XXX subjects. 
%
\section{Discussion}
%
The experiments were run on a Linux machine with an Intel Xeon 2.27 GHz CPU and 48 GB of RAM. Generating the alpha shape and the graph search takes XXX and XXX minutes of computer time, respectively. The manual segmentation took on average XXX per lung.

Our future directions involve learning the optimal alpha for a given subject rather than using the same alpha for all subject. Additionally, we plan to experiment with learning a spatially varying alpha to overcome over segmentation near the aorta.
%
\section{Summary}
%
We proposed a method for segmentation of lungs in the presence of large tumors. The method is utilizes an intensity based segmentation, alpha shapes, and a graph search. A DICE coefficient of XXX and a surface distance of XXX were achieved. The accurate lung segmentation with  inclusion of tumor regions is valuable for radiation therapy treatment planning and further quantitative analysis.
%
\section{Acknowledgments}
%
This work was supported in part by NIH grant CA166703.



%
% ---- Bibliography ----
%
\bibliography{refs.bib}
\bibliographystyle{splncs03}







\clearpage
\addtocmark[2]{Author Index} % additional numbered TOC entry
\renewcommand{\indexname}{Author Index}
\printindex
\clearpage
\iffalse
\addtocmark[2]{Subject Index} % additional numbered TOC entry
\markboth{Subject Index}{Subject Index}
\renewcommand{\indexname}{Subject Index}
\input{subjidx.tex}
\fi
\end{document}
